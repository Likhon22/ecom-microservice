_format_version: "3.0"
_transform: true

# Global logging (all requests)
plugins:
  - name: prometheus
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  - name: file-log
    config:
      path: /tmp/kong-access.log
      reopen: true

services:
  - name: auth-service
    url: grpc://host.docker.internal:5002
    routes:
      - name: create-user-route
        paths: [/users]
        methods: [POST]
        plugins:
          - name: auth-token-validator
            config:
              jwt_secret: "very very secret access token"
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              policy: local

      - name: login-route
        paths: [/auth/login]
        methods: [POST]
        plugins:
          - name: grpc-cookie-transformer
          - name: rate-limiting
            config:
              minute: 10 # Strict: prevent brute force
              hour: 50
              policy: local
              limit_by: ip # Limit by IP address

      - name: validation-route
        paths: [/auth/refresh/validate]
        methods: [POST]
        plugins:
          - name: auth-metadata-setter
          - name: grpc-cookie-transformer
          - name: rate-limiting
            config:
              minute: 200
              policy: local

      - name: logout-route
        paths: [/auth/logout]
        methods: [POST]
        plugins:
          - name: auth-metadata-setter
          - name: auth-cookie-clearer
          - name: rate-limiting
            config:
              minute: 50
              policy: local

    plugins:
      - name: grpc-gateway
        config:
          proto: "/kong/protos/auth.proto"

  - name: user-service
    url: grpc://host.docker.internal:5001
    routes:
      - name: get-all-user-routes
        paths: [/customers]
        methods: [GET]
        plugins:
          - name: rate-limiting
            config:
              minute: 300
              policy: local
          - name: auth-token-validator
            config:
              jwt_secret: "very very secret access token"

    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/protos/user.proto

  - name: product-service
    url: grpc://host.docker.internal:5003
    routes:
      - name: create-products
        paths: [/products]
        methods: [POST]
        plugins:
          - name: auth-token-validator
            config:
              jwt_secret: "very very secret access token"
          - name: user-context-injector
      - name: get-products
        paths: ["/products"]
        methods: [GET]
      - name: get-product-by-id
        paths: ["/products/:category/:product_id"]
        methods: [GET]
      - name: update-product
        paths: ["~/products/[^/]+/[^/]+"]
        methods: [PATCH]
        plugins:
          - name: auth-token-validator
            config:
              jwt_secret: "very very secret access token"
          - name: user-context-injector

      - name: delete-product
        paths: ["~/products/[^/]+/[^/]+"]
        methods: [DELETE]
        plugins:
          - name: auth-token-validator
            config:
              jwt_secret: "very very secret access token"

    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/protos/product.proto

  - name: cart-service
    url: grpc://host.docker.internal:5004
    routes:
      - name: create-cart
        paths: [/cart/add]
        methods: [POST]
